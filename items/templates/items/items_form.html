{% extends 'items/base.html' %}

{% load static %}
{% load crispy_forms_tags %}

{% block title %}Cadastro de Itens{% endblock %}
{% block extra_styles %}
  <link rel="stylesheet" href="{% static 'css/items_form.css' %}">
{% endblock %}

{% block content %}

  <div class="container">

    <h1>{{ title }}</h1>
    
    <!-- Item já existe -->
    {% if object.pk %}

      <!-- Formulário de atualização -->
      <form class="form" method="POST">
        {% csrf_token %}

        <!-- Renderiza os campos automaticamente -->
        {% for field in form %}
          <div class="form-group">
            {{ field.label_tag }}
            {{ field }}
          </div>
        {% endfor %}

        <button type="submit" class="btn btn-save">Atualizar</button>
        <a href="{{ previous_page }}" class="btn btn-cancelar">Cancelar</a>

    </form>

    <!-- Item sendo criado -->
    {% else %}

      <form class="form" method="POST">
        {% csrf_token %}

        {% if form.errors %}
          <div class="alert alert-danger">
            <strong>Corrija os erros abaixo:</strong>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        
        <!-- Renderização oscampos automaticamente -->
        {% for field in form %}
          <div class="form-group">

            <!-- Renderizando o campo de input ou select -->
            {% if field.name == 'category' %}

              <!-- Categoria: irá disparar a lógica de subcategoria -->
              {{ field.label_tag }}
              {{ field }}  <!-- Este será o <select> de categoria -->

            {% elif field.name == 'sub_category' %}

              <!-- Subcategoria: será preenchido dinamicamente -->
              {{ field.label_tag }}
              {{ field }}

            {% else %}

              {{ field.label_tag }}
              {{ field }}
              
            {% endif %}

          </div>
        {% endfor %}

        <button type = "submit" class = "btn btn-save"> Salvar </button>
        <a href = "{{ previous_page }}" class = "btn btn-cancelar"> Cancelar </a>

      </form>

      <script type="text/javascript">
        $(document).ready(function() {
          $('#id_category').change(function() {
            var category = $(this).val();
            $.ajax({
              url: '{% url "ajax-load-subcategories" %}',
              data: {
                'category': category
              },
              success: function(data) {
                var $subCategory = $('#id_sub_category');
                $subCategory.empty();
                $.each(data, function(index, value) {
                  $subCategory.append($('<option></option>').attr('value', value).text(value));
                });
              }
            });
          });

          var initialCategory = $('#id_category').val();
          if (initialCategory) {
            $.ajax({
              url: '{% url "ajax-load-subcategories" %}',
              data: {
                'category': initialCategory
              },
              success: function(data) {
                var $subCategory = $('#id_sub_category');
                $subCategory.empty();
                $subCategory.append('<option value="">Selecione</option>');
                $.each(data, function(index, value) {
                  $subCategory.append('<option value="' + value + '">' + value + '</option>');
                });
              }
            });
          }
        });
      </script>

    {% endif %}
  </div>

{% endblock %}